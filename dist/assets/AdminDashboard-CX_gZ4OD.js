import{c as S,J as a,O as T,j as e,P as U,Q as y,S as D,T as k}from"./index-B22AmSHL.js";/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],v=S("circle-x",B);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],O=S("search",M),z=()=>{const[_,L]=a.useState([]),[C,h]=a.useState(!0),[x,p]=a.useState(null),[A,b]=a.useState(null),[f,g]=a.useState(!1),[c,R]=a.useState(""),[u,d]=a.useState(null),[j,P]=a.useState({});a.useEffect(()=>{m()},[]);const m=async()=>{h(!0),p(null),b(null),g(!1);try{const s=new Promise((o,$)=>setTimeout(()=>$(new Error("Request timed out. Check your network or RLS policies.")),1e4)),t=await Promise.race([T(),s]),{data:l,error:r}=t||{};r?(console.error("Failed to fetch users:",r),p(r.message||JSON.stringify(r)),b(r.code||null)):l&&L(l)}catch(s){console.error("Fetch error:",s),p(s.message||"Unknown error occurred")}finally{h(!1)}},F=async s=>{if(s.role==="blocked"){alert("This user is blocked. Unblock them first if you want to grant access.");return}if(!confirm(`Are you sure you want to ${s.is_subscribed?"REMOVE":"GRANT"} subscription for ${s.email}?`))return;d(s.id);const t=j[s.id]||"4-months",l=t==="2-months"?2:t==="6-months"?6:4,r=s.is_subscribed?{is_subscribed:!1,subscription_plan:null,subscription_end_date:null}:{is_subscribed:!0,subscription_plan:t,subscription_end_date:new Date(new Date().setMonth(new Date().getMonth()+l)).toISOString()},{error:o}=await k(s.id,r);o?alert("Failed to update: "+o.message):await m(),d(null)},E=async s=>{if(s.role==="admin"){alert("Admins cannot be blocked.");return}const t=s.role==="blocked";if(!confirm(`Are you sure you want to ${t?"UNBLOCK":"BLOCK"} ${s.email}?`))return;d(s.id);const r=t?{role:"user"}:{role:"blocked",is_subscribed:!1,subscription_plan:null,subscription_end_date:null},{error:o}=await k(s.id,r);o?alert("Failed to update: "+o.message):await m(),d(null)},w=_.filter(s=>{var t,l;return((t=s.email)==null?void 0:t.toLowerCase().includes(c.toLowerCase()))||((l=s.full_name)==null?void 0:l.toLowerCase().includes(c.toLowerCase()))}),i=(x||"").toLowerCase(),n=A==="42501"||i.includes("permission")||i.includes("rls")||i.includes("not authorized"),N=i.includes("timed out")||i.includes("timeout");return e.jsx("div",{className:"min-h-screen bg-slate-950 text-slate-200 font-sans p-6",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent",children:"Admin Dashboard"}),e.jsx("p",{className:"text-slate-500 mt-1",children:"Manage users and subscriptions"})]}),e.jsx("button",{onClick:()=>window.location.href="/",className:"px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors",children:"Back to App"})]}),e.jsxs("div",{className:"bg-slate-900/50 border border-slate-800 rounded-xl p-4 mb-6 flex gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(O,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"}),e.jsx("input",{type:"text",placeholder:"Search by email or name...",value:c,onChange:s=>R(s.target.value),className:"w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-purple-500"})]}),e.jsx("button",{onClick:m,className:"px-4 py-2 bg-purple-600/20 text-purple-300 hover:bg-purple-600/30 rounded-lg text-sm font-medium transition-colors",children:"Refresh List"})]}),!1,e.jsxs("div",{className:"bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl",children:[x&&e.jsxs("div",{className:"p-4 bg-red-900/50 border-l-4 border-red-500 text-red-200 mb-4 mx-4 mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 flex-shrink-0"}),e.jsx("strong",{children:"Error Loading Data:"})," ",x]}),e.jsxs("div",{className:"text-sm opacity-80 mt-1",children:[n&&"Likely cause: RLS policy is blocking admin access.",!n&&N&&"Likely cause: network timeout or Supabase URL/key misconfigured.",!n&&!N&&"Likely cause: network error or permissions."]}),n&&e.jsx("button",{onClick:()=>g(s=>!s),className:"mt-3 px-3 py-1.5 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/30 text-xs font-medium",children:f?"Hide Fix":"Show RLS Fix SQL"}),n&&f&&e.jsx("pre",{className:"mt-3 text-xs bg-black/40 border border-red-500/30 rounded-lg p-3 overflow-auto whitespace-pre-wrap",children:`-- Enable RLS if it isn't already
alter table public.profiles enable row level security;

-- Allow users to read their own profile
create policy "Profiles: read own"
on public.profiles for select
using (auth.uid() = id);

-- Allow admins to read all profiles
create policy "Profiles: admin read"
on public.profiles for select
using (
  exists (
    select 1 from public.profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
);

-- Allow admins to update profiles
create policy "Profiles: admin update"
on public.profiles for update
using (
  exists (
    select 1 from public.profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
)
with check (
  exists (
    select 1 from public.profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
);`})]}),C?e.jsx("div",{className:"p-12 flex justify-center",children:e.jsx(y,{className:"w-8 h-8 animate-spin text-purple-500"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider",children:[e.jsx("th",{className:"p-4 font-medium",children:"User"}),e.jsx("th",{className:"p-4 font-medium",children:"Role"}),e.jsx("th",{className:"p-4 font-medium",children:"Status"}),e.jsx("th",{className:"p-4 font-medium",children:"Plan"}),e.jsx("th",{className:"p-4 font-medium text-right",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-slate-800",children:[w.map(s=>e.jsxs("tr",{className:"hover:bg-slate-800/30 transition-colors",children:[e.jsxs("td",{className:"p-4",children:[e.jsx("div",{className:"font-medium text-white",children:s.email}),e.jsx("div",{className:"text-xs text-slate-500",children:s.full_name||"No Name"}),e.jsx("div",{className:"text-[10px] text-slate-600 font-mono mt-0.5",children:s.id})]}),e.jsx("td",{className:"p-4",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${s.role==="admin"?"bg-purple-500/20 text-purple-300":"bg-slate-700/50 text-slate-400"}`,children:s.role||"user"})}),e.jsx("td",{className:"p-4",children:s.role==="blocked"?e.jsxs("div",{className:"flex items-center gap-1.5 text-red-400 text-sm",children:[e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:"Blocked"})]}):s.is_subscribed?e.jsxs("div",{className:"flex items-center gap-1.5 text-green-400 text-sm",children:[e.jsx(D,{className:"w-4 h-4"}),e.jsx("span",{children:"Active"})]}):e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500 text-sm",children:[e.jsx(v,{className:"w-4 h-4"}),e.jsx("span",{children:"Free"})]})}),e.jsxs("td",{className:"p-4 text-sm text-slate-400",children:[s.subscription_plan||"-",s.subscription_end_date&&e.jsxs("div",{className:"text-[10px] text-slate-600",children:["Ends: ",new Date(s.subscription_end_date).toLocaleDateString()]})]}),e.jsx("td",{className:"p-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[!s.is_subscribed&&s.role!=="blocked"&&e.jsxs("select",{value:j[s.id]||"4-months",onChange:t=>P(l=>({...l,[s.id]:t.target.value})),className:"bg-slate-900/70 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5 focus:outline-none focus:border-purple-500",children:[e.jsx("option",{value:"2-months",children:"2 months"}),e.jsx("option",{value:"4-months",children:"4 months"}),e.jsx("option",{value:"6-months",children:"6 months"})]}),e.jsx("button",{onClick:()=>F(s),disabled:u===s.id||s.role==="blocked",className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${s.is_subscribed?"bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20":"bg-green-500/10 text-green-400 hover:bg-green-500/20 border border-green-500/20"} ${s.role==="blocked"?"opacity-50 cursor-not-allowed":""}`,children:u===s.id?e.jsx(y,{className:"w-4 h-4 animate-spin"}):s.is_subscribed?"Revoke Access":"Grant Access"}),e.jsx("button",{onClick:()=>E(s),disabled:u===s.id||s.role==="admin",className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${s.role==="blocked"?"bg-slate-700/40 text-slate-300 hover:bg-slate-700/60 border border-slate-600/40":"bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20"} ${s.role==="admin"?"opacity-50 cursor-not-allowed":""}`,children:s.role==="blocked"?"Unblock":"Reject"})]})})]},s.id)),w.length===0&&e.jsx("tr",{children:e.jsxs("td",{colSpan:5,className:"p-8 text-center text-slate-500",children:['No users found matching "',c,'"']})})]})]})})]})]})})};export{z as default};
