import{c as O,J as l,P as te,j as s,Q as le,S as k,T as re,U as ae,V as B}from"./index-BrAcjBp5.js";/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],G=O("circle-x",oe);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],ne=O("search",ie),xe=()=>{const[S,b]=l.useState([]),[f,_]=l.useState(!0),[g,L]=l.useState(!1),[j,w]=l.useState(null),[Z,C]=l.useState(null),[A,E]=l.useState(!1),[N,q]=l.useState(""),[p,d]=l.useState(null),[P,z]=l.useState({}),[H,R]=l.useState(0),[J,U]=l.useState(!0),y=l.useRef(0),[K,F]=l.useState(new Set);l.useEffect(()=>{c(!0)},[]);const Q=e=>e.toLowerCase().includes("abort"),D=e=>Q(e)||e.toLowerCase().includes("timeout"),M=e=>y.current>=2?!1:(y.current+=1,setTimeout(()=>c(e,{isRetry:!0}),1200),!0),c=async(e=!0,t)=>{const r=!!(t!=null&&t.isRetry);let i=!1;e?(r||(y.current=0,b([]),R(0),U(!0),F(new Set)),_(!0),w(null),C(null),E(!1)):L(!0);try{const a=new Promise((n,v)=>setTimeout(()=>v(new Error("Request timed out. Check your network.")),2e4)),o=e?0:H+1,ee={from:o*200,to:o*200+200-1},se=await Promise.race([te(ee),a]),{data:$,error:x}=se||{};if(x){console.error("Failed to fetch users:",x);const n=x.message||JSON.stringify(x);if(D(n)&&M(e)){i=!0;return}w(n),C(x.code||null)}else if($){const n=$||[];b(v=>e?n:[...v,...n]),R(o),U(n.length===200)}}catch(a){console.error("Fetch error:",a);const o=(a==null?void 0:a.message)||String(a)||"Unknown error occurred";if(D(o)&&M(e)){i=!0;return}w(o)}finally{if(i)return;e?_(!1):L(!1)}},V=async e=>{if(e.role==="blocked"){alert("This user is blocked. Unblock them first if you want to grant access.");return}const t=e.email||e.id;if(!confirm(`Are you sure you want to ${e.is_subscribed?"REMOVE":"GRANT"} subscription for ${t}?`))return;d(e.id);const r=P[e.id]||"4-months",i=r==="2-months"?2:r==="6-months"?6:4,a=e.is_subscribed?{is_subscribed:!1,subscription_plan:null,subscription_end_date:null}:{is_subscribed:!0,subscription_plan:r,subscription_end_date:new Date(new Date().setMonth(new Date().getMonth()+i)).toISOString()},{error:o}=await B(e.id,a);o?alert("Failed to update: "+o.message):await c(),d(null)},X=async e=>{if(e.role==="admin"){alert("Admins cannot be blocked.");return}const t=e.role==="blocked",r=t?"UNBLOCK":"BLOCK",i=e.email||e.id;if(!confirm(`Are you sure you want to ${r} ${i}?`))return;d(e.id);const a=t?{role:"user"}:{role:"blocked",is_subscribed:!1,subscription_plan:null,subscription_end_date:null},{error:o}=await B(e.id,a);o?alert("Failed to update: "+o.message):await c(),d(null)},W=async e=>{const t=e.email||e.id;if(!confirm(`Permanently DELETE ${t}? This removes the user from Auth and Profiles.`))return;d(e.id);const{error:r}=await ae(e.id);r?alert("Failed to delete: "+(r.message||JSON.stringify(r))):b(i=>i.filter(a=>a.id!==e.id)),d(null)},h=N.trim().toLowerCase(),T=(h.length===0?S:S.filter(e=>(e.email||"").toLowerCase().includes(h)||(e.full_name||"").toLowerCase().includes(h)||e.id.toLowerCase().includes(h))).filter(e=>!K.has(e.id)),m=(j||"").toLowerCase(),u=Z==="42501"||m.includes("permission")||m.includes("rls")||m.includes("not authorized"),I=m.includes("timed out")||m.includes("timeout"),Y=m.includes("abort");return s.jsx("div",{className:"min-h-screen bg-slate-950 text-slate-200 font-sans p-6",children:s.jsxs("div",{className:"max-w-6xl mx-auto",children:[s.jsxs("div",{className:"flex justify-between items-center mb-8",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent",children:"Admin Dashboard"}),s.jsx("p",{className:"text-slate-500 mt-1",children:"Manage users and subscriptions"})]}),s.jsx("button",{onClick:()=>window.location.href="/",className:"px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors",children:"Back to App"})]}),s.jsxs("div",{className:"bg-slate-900/50 border border-slate-800 rounded-xl p-4 mb-6 flex gap-4",children:[s.jsxs("div",{className:"relative flex-1 max-w-md",children:[s.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"}),s.jsx("input",{type:"text",placeholder:"Search by email or name...",value:N,onChange:e=>q(e.target.value),className:"w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-purple-500"})]}),s.jsx("button",{onClick:()=>c(!0),disabled:f,className:"px-4 py-2 bg-purple-600/20 text-purple-300 hover:bg-purple-600/30 rounded-lg text-sm font-medium transition-colors",children:"Refresh List"})]}),!1,s.jsxs("div",{className:"bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl",children:[j&&s.jsxs("div",{className:"p-4 bg-red-900/50 border-l-4 border-red-500 text-red-200 mb-4 mx-4 mt-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(le,{className:"w-5 h-5 flex-shrink-0"}),s.jsx("strong",{children:"Error Loading Data:"})," ",j]}),s.jsxs("div",{className:"text-sm opacity-80 mt-1",children:[u&&"Likely cause: RLS policy is blocking admin access.",!u&&(I||Y)&&"Likely cause: network timeout or Supabase URL/key misconfigured.",!u&&!I&&"Likely cause: network error or permissions."]}),u&&s.jsx("button",{onClick:()=>E(e=>!e),className:"mt-3 px-3 py-1.5 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/30 text-xs font-medium",children:A?"Hide Fix":"Show RLS Fix SQL"}),u&&A&&s.jsx("pre",{className:"mt-3 text-xs bg-black/40 border border-red-500/30 rounded-lg p-3 overflow-auto whitespace-pre-wrap",children:`-- Enable RLS if it isn't already
alter table public.profiles enable row level security;

-- Allow users to read their own profile
create policy "Profiles: read own"
on public.profiles for select
using (auth.uid() = id);

-- Allow admins to read all profiles
create policy "Profiles: admin read"
on public.profiles for select
using (
  exists (
    select 1 from public.profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
);

-- Allow admins to update profiles
create policy "Profiles: admin update"
on public.profiles for update
using (
  exists (
    select 1 from public.profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
)
with check (
  exists (
    select 1 from public.profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
);`})]}),f?s.jsx("div",{className:"p-12 flex justify-center",children:s.jsx(k,{className:"w-8 h-8 animate-spin text-purple-500"})}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full text-left border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider",children:[s.jsx("th",{className:"p-4 font-medium",children:"User"}),s.jsx("th",{className:"p-4 font-medium",children:"Role"}),s.jsx("th",{className:"p-4 font-medium",children:"Status"}),s.jsx("th",{className:"p-4 font-medium",children:"Plan"}),s.jsx("th",{className:"p-4 font-medium text-right",children:"Actions"})]})}),s.jsxs("tbody",{className:"divide-y divide-slate-800",children:[T.map(e=>s.jsxs("tr",{className:"hover:bg-slate-800/30 transition-colors",children:[s.jsxs("td",{className:"p-4",children:[s.jsx("div",{className:"font-medium text-white",children:e.email||"(no email in profile)"}),s.jsx("div",{className:"text-xs text-slate-500",children:e.full_name||"No Name"}),s.jsx("div",{className:"text-[10px] text-slate-600 font-mono mt-0.5",children:e.id})]}),s.jsx("td",{className:"p-4",children:s.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${e.role==="admin"?"bg-purple-500/20 text-purple-300":"bg-slate-700/50 text-slate-400"}`,children:e.role||"user"})}),s.jsx("td",{className:"p-4",children:e.role==="blocked"?s.jsxs("div",{className:"flex items-center gap-1.5 text-red-400 text-sm",children:[s.jsx(G,{className:"w-4 h-4"}),s.jsx("span",{children:"Blocked"})]}):e.is_subscribed?s.jsxs("div",{className:"flex items-center gap-1.5 text-green-400 text-sm",children:[s.jsx(re,{className:"w-4 h-4"}),s.jsx("span",{children:"Active"})]}):s.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500 text-sm",children:[s.jsx(G,{className:"w-4 h-4"}),s.jsx("span",{children:"Free"})]})}),s.jsxs("td",{className:"p-4 text-sm text-slate-400",children:[e.subscription_plan||"-",e.subscription_end_date&&s.jsxs("div",{className:"text-[10px] text-slate-600",children:["Ends: ",new Date(e.subscription_end_date).toLocaleDateString()]})]}),s.jsx("td",{className:"p-4 text-right",children:s.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.jsx("button",{onClick:()=>F(t=>new Set(t).add(e.id)),className:"px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-slate-700/40 text-slate-300 hover:bg-slate-700/60 border border-slate-600/40",children:"Remove"}),s.jsx("button",{onClick:()=>W(e),disabled:p===e.id,className:"px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-red-600/20 text-red-300 hover:bg-red-600/30 border border-red-500/20",children:"Delete"}),!e.is_subscribed&&e.role!=="blocked"&&s.jsxs("select",{value:P[e.id]||"4-months",onChange:t=>z(r=>({...r,[e.id]:t.target.value})),className:"bg-slate-900/70 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5 focus:outline-none focus:border-purple-500",children:[s.jsx("option",{value:"2-months",children:"2 months"}),s.jsx("option",{value:"4-months",children:"4 months"}),s.jsx("option",{value:"6-months",children:"6 months"})]}),s.jsx("button",{onClick:()=>V(e),disabled:p===e.id||e.role==="blocked",className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${e.is_subscribed?"bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20":"bg-green-500/10 text-green-400 hover:bg-green-500/20 border border-green-500/20"} ${e.role==="blocked"?"opacity-50 cursor-not-allowed":""}`,children:p===e.id?s.jsx(k,{className:"w-4 h-4 animate-spin"}):e.is_subscribed?"Revoke Access":"Grant Access"}),s.jsx("button",{onClick:()=>X(e),disabled:p===e.id||e.role==="admin",className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${e.role==="blocked"?"bg-slate-700/40 text-slate-300 hover:bg-slate-700/60 border border-slate-600/40":"bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20"} ${e.role==="admin"?"opacity-50 cursor-not-allowed":""}`,children:e.role==="blocked"?"Unblock":"Reject"})]})})]},e.id)),T.length===0&&s.jsx("tr",{children:s.jsxs("td",{colSpan:5,className:"p-8 text-center text-slate-500",children:['No users found matching "',N,'"']})})]})]})}),!f&&J&&s.jsx("div",{className:"p-4 flex justify-center border-t border-slate-800",children:s.jsxs("button",{onClick:()=>c(!1),disabled:g,className:"px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm text-slate-200 transition-colors flex items-center gap-2",children:[g&&s.jsx(k,{className:"w-4 h-4 animate-spin"}),g?"Loading...":"Load More"]})})]})]})})};export{xe as default};
