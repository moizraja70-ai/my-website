import{a as e,j as s,w as t,C as r,d as l,x as n,c as i}from"./vendor-react-DkY5wy_m.js";import{g as a,c as o,u as d}from"./index-B-WdmxAS.js";import"./vendor-CimuxmzX.js";import"./vendor-markdown-CUtcwKjt.js";import"./vendor-react-dom-D9MoHZUj.js";import"./content-gic-thwEcWs7.js";import"./content-impression-DXBt_6OM.js";import"./content-gypsum-BiKxCYUT.js";import"./content-composite-TJ9nDpJr.js";import"./content-adhesion-Cn4bavKK.js";import"./content-wax-BDxVPrGY.js";import"./content-metals-D-Ap74sk.js";import"./content-investment-BmTIz0j7.js";import"./content-casting-qFCp4nAV.js";import"./content-cements-BGuPplC7.js";import"./content-amalgam-BEu4a1oj.js";import"./content-ceramics-BD3nGYw3.js";import"./content-properties-BHcOlrks.js";import"./content-denture-B8gJ77JC.js";import"./content-embryology-Czmh6K7E.js";const c=()=>{var c;const m=200,[u,p]=e.useState([]),[x,b]=e.useState(!0),[h,f]=e.useState(!1),[g,j]=e.useState(null),[w,N]=e.useState(null),[v,y]=e.useState(!1),[k,S]=e.useState(""),[_,L]=e.useState(null),[C,A]=e.useState({}),[R,E]=e.useState(0),[$,D]=e.useState(!0),P=e.useRef(0),[M,U]=e.useState(new Set),[F,O]=e.useState("rejected");e.useEffect(()=>{G(!0)},[]);const T=e=>(e=>e.toLowerCase().includes("abort"))(e)||e.toLowerCase().includes("timeout"),B=e=>!(P.current>=2)&&(P.current+=1,setTimeout(()=>G(e,{isRetry:!0}),1200),!0),G=async(e=!0,s)=>{const t=!!(null==s?void 0:s.isRetry);let r=!1;e?(t||(P.current=0,p([]),E(0),D(!0),U(new Set)),b(!0),j(null),N(null),y(!1)):f(!0);try{const s=new Promise((e,s)=>setTimeout(()=>s(new Error("Request timed out. Check your network.")),2e4)),t=e?0:R+1,l={from:t*m,to:t*m+m-1},n=await Promise.race([a(l),s]),{data:i,error:o}=n||{};if(o){const s=o.message||JSON.stringify(o);if(T(s)&&B(e))return void(r=!0);j(s),N(o.code||null)}else if(i){const s=i||[];p(t=>e?s:[...t,...s]),E(t),D(s.length===m)}}catch(l){const s=(null==l?void 0:l.message)||String(l)||"Unknown error occurred";if(T(s)&&B(e))return void(r=!0);j(s)}finally{if(r)return;e?b(!1):f(!1)}},J=k.trim().toLowerCase(),K=(0===J.length?u:u.filter(e=>(e.email||"").toLowerCase().includes(J)||(e.full_name||"").toLowerCase().includes(J)||e.id.toLowerCase().includes(J))).filter(e=>!M.has(e.id)),q={all:K,rejected:K.filter(e=>"blocked"===e.role),"2-months":K.filter(e=>"2-months"===e.subscription_plan),"4-months":K.filter(e=>"4-months"===e.subscription_plan),admins:K.filter(e=>"admin"===e.role)},z=q[F],H=[{key:"rejected",label:"Rejected"},{key:"2-months",label:"2 Months"},{key:"4-months",label:"4 Months"},{key:"admins",label:"Admins"},{key:"all",label:"All Users"}],I=(g||"").toLowerCase(),Q="42501"===w||I.includes("permission")||I.includes("rls")||I.includes("not authorized"),V=I.includes("timed out")||I.includes("timeout"),W=I.includes("abort");return s.jsx("div",{className:"min-h-screen bg-slate-950 text-slate-200 font-sans p-6",children:s.jsxs("div",{className:"max-w-6xl mx-auto",children:[s.jsxs("div",{className:"flex justify-between items-center mb-8",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent",children:"Admin Dashboard"}),s.jsx("p",{className:"text-slate-500 mt-1",children:"Manage users and subscriptions"})]}),s.jsx("button",{onClick:()=>window.location.href="/",className:"px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors",children:"Back to App"})]}),s.jsxs("div",{className:"bg-slate-900/50 border border-slate-800 rounded-xl p-4 mb-6 flex gap-4",children:[s.jsxs("div",{className:"relative flex-1 max-w-md",children:[s.jsx(t,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"}),s.jsx("input",{type:"text",placeholder:"Search by email or name...",value:k,onChange:e=>S(e.target.value),className:"w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-purple-500"})]}),s.jsx("button",{onClick:()=>G(!0),disabled:x,className:"px-4 py-2 bg-purple-600/20 text-purple-300 hover:bg-purple-600/30 rounded-lg text-sm font-medium transition-colors",children:"Refresh List"})]}),s.jsx("div",{className:"mb-6 flex flex-wrap gap-2",children:H.map(e=>{const t=F===e.key;return s.jsxs("button",{onClick:()=>O(e.key),className:"px-3 py-2 rounded-lg text-sm border transition-colors "+(t?"bg-purple-600/20 text-purple-200 border-purple-500/50":"bg-slate-900 text-slate-300 border-slate-700 hover:bg-slate-800"),children:[e.label," (",q[e.key].length,")"]},e.key)})}),!1,s.jsxs("div",{className:"bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl",children:[g&&s.jsxs("div",{className:"p-4 bg-red-900/50 border-l-4 border-red-500 text-red-200 mb-4 mx-4 mt-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(r,{className:"w-5 h-5 flex-shrink-0"}),s.jsx("strong",{children:"Error Loading Data:"})," ",g]}),s.jsxs("div",{className:"text-sm opacity-80 mt-1",children:[Q&&"Likely cause: RLS policy is blocking admin access.",!Q&&(V||W)&&"Likely cause: network timeout or Supabase URL/key misconfigured.",!Q&&!V&&"Likely cause: network error or permissions."]}),Q&&s.jsx("button",{onClick:()=>y(e=>!e),className:"mt-3 px-3 py-1.5 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/30 text-xs font-medium",children:v?"Hide Fix":"Show RLS Fix SQL"}),Q&&v&&s.jsx("pre",{className:"mt-3 text-xs bg-black/40 border border-red-500/30 rounded-lg p-3 overflow-auto whitespace-pre-wrap",children:"-- Enable RLS if it isn't already\nalter table public.profiles enable row level security;\n\n-- Allow users to read their own profile\ncreate policy \"Profiles: read own\"\non public.profiles for select\nusing (auth.uid() = id);\n\n-- Allow admins to read all profiles\ncreate policy \"Profiles: admin read\"\non public.profiles for select\nusing (\n  exists (\n    select 1 from public.profiles p\n    where p.id = auth.uid() and p.role = 'admin'\n  )\n);\n\n-- Allow admins to update profiles\ncreate policy \"Profiles: admin update\"\non public.profiles for update\nusing (\n  exists (\n    select 1 from public.profiles p\n    where p.id = auth.uid() and p.role = 'admin'\n  )\n)\nwith check (\n  exists (\n    select 1 from public.profiles p\n    where p.id = auth.uid() and p.role = 'admin'\n  )\n);"})]}),x?s.jsx("div",{className:"p-12 flex justify-center",children:s.jsx(l,{className:"w-8 h-8 animate-spin text-purple-500"})}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full text-left border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider",children:[s.jsx("th",{className:"p-4 font-medium",children:"User"}),s.jsx("th",{className:"p-4 font-medium",children:"Role"}),s.jsx("th",{className:"p-4 font-medium",children:"Status"}),s.jsx("th",{className:"p-4 font-medium",children:"Plan"}),s.jsx("th",{className:"p-4 font-medium text-right",children:"Actions"})]})}),s.jsxs("tbody",{className:"divide-y divide-slate-800",children:[z.map(e=>s.jsxs("tr",{className:"hover:bg-slate-800/30 transition-colors",children:[s.jsxs("td",{className:"p-4",children:[s.jsx("div",{className:"font-medium text-white",children:e.email||"(no email in profile)"}),s.jsx("div",{className:"text-xs text-slate-500",children:e.full_name||"No Name"}),s.jsx("div",{className:"text-[10px] text-slate-600 font-mono mt-0.5",children:e.id})]}),s.jsx("td",{className:"p-4",children:s.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium "+("admin"===e.role?"bg-purple-500/20 text-purple-300":"bg-slate-700/50 text-slate-400"),children:e.role||"user"})}),s.jsx("td",{className:"p-4",children:"blocked"===e.role?s.jsxs("div",{className:"flex items-center gap-1.5 text-red-400 text-sm",children:[s.jsx(n,{className:"w-4 h-4"}),s.jsx("span",{children:"Blocked"})]}):e.is_subscribed?s.jsxs("div",{className:"flex items-center gap-1.5 text-green-400 text-sm",children:[s.jsx(i,{className:"w-4 h-4"}),s.jsx("span",{children:"Active"})]}):s.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500 text-sm",children:[s.jsx(n,{className:"w-4 h-4"}),s.jsx("span",{children:"Free"})]})}),s.jsxs("td",{className:"p-4 text-sm text-slate-400",children:[e.subscription_plan||"-",e.subscription_end_date&&s.jsxs("div",{className:"text-[10px] text-slate-600",children:["Ends: ",new Date(e.subscription_end_date).toLocaleDateString()]})]}),s.jsx("td",{className:"p-4 text-right",children:s.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.jsx("button",{onClick:()=>U(s=>new Set(s).add(e.id)),className:"px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-slate-700/40 text-slate-300 hover:bg-slate-700/60 border border-slate-600/40",children:"Remove"}),s.jsx("button",{onClick:()=>(async e=>{const s=e.email||e.id;if(!confirm(`Permanently DELETE ${s}? This removes the user from Auth and Profiles.`))return;L(e.id);const{error:t}=await o(e.id);t?alert("Failed to delete: "+(t.message||JSON.stringify(t))):p(s=>s.filter(s=>s.id!==e.id)),L(null)})(e),disabled:_===e.id,className:"px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-red-600/20 text-red-300 hover:bg-red-600/30 border border-red-500/20",children:"Delete"}),!e.is_subscribed&&"blocked"!==e.role&&s.jsxs("select",{value:C[e.id]||"4-months",onChange:s=>A(t=>({...t,[e.id]:s.target.value})),className:"bg-slate-900/70 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5 focus:outline-none focus:border-purple-500",children:[s.jsx("option",{value:"2-months",children:"2 months"}),s.jsx("option",{value:"4-months",children:"4 months"}),s.jsx("option",{value:"6-months",children:"6 months"})]}),s.jsx("button",{onClick:()=>(async e=>{if("blocked"===e.role)return void alert("This user is blocked. Unblock them first if you want to grant access.");const s=e.email||e.id;if(!confirm(`Are you sure you want to ${e.is_subscribed?"REMOVE":"GRANT"} subscription for ${s}?`))return;L(e.id);const t=C[e.id]||"4-months",r="2-months"===t?2:"6-months"===t?6:4,l=e.is_subscribed?{is_subscribed:!1,subscription_plan:null,subscription_end_date:null}:{is_subscribed:!0,subscription_plan:t,subscription_end_date:new Date((new Date).setMonth((new Date).getMonth()+r)).toISOString()},{error:n}=await d(e.id,l);n?alert("Failed to update: "+n.message):await G(),L(null)})(e),disabled:_===e.id||"blocked"===e.role,className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${e.is_subscribed?"bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20":"bg-green-500/10 text-green-400 hover:bg-green-500/20 border border-green-500/20"} ${"blocked"===e.role?"opacity-50 cursor-not-allowed":""}`,children:_===e.id?s.jsx(l,{className:"w-4 h-4 animate-spin"}):e.is_subscribed?"Revoke Access":"Grant Access"}),s.jsx("button",{onClick:()=>(async e=>{if("admin"===e.role)return void alert("Admins cannot be blocked.");const s="blocked"===e.role,t=s?"UNBLOCK":"BLOCK",r=e.email||e.id;if(!confirm(`Are you sure you want to ${t} ${r}?`))return;L(e.id);const l=s?{role:"user"}:{role:"blocked",is_subscribed:!1,subscription_plan:null,subscription_end_date:null},{error:n}=await d(e.id,l);n?alert("Failed to update: "+n.message):await G(),L(null)})(e),disabled:_===e.id||"admin"===e.role,className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${"blocked"===e.role?"bg-slate-700/40 text-slate-300 hover:bg-slate-700/60 border border-slate-600/40":"bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20"} ${"admin"===e.role?"opacity-50 cursor-not-allowed":""}`,children:"blocked"===e.role?"Unblock":"Reject"})]})})]},e.id)),0===z.length&&s.jsx("tr",{children:s.jsxs("td",{colSpan:5,className:"p-8 text-center text-slate-500",children:['No users found in "',null==(c=H.find(e=>e.key===F))?void 0:c.label,'"',k?` matching "${k}"`:""]})})]})]})}),!x&&$&&s.jsx("div",{className:"p-4 flex justify-center border-t border-slate-800",children:s.jsxs("button",{onClick:()=>G(!1),disabled:h,className:"px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm text-slate-200 transition-colors flex items-center gap-2",children:[h&&s.jsx(l,{className:"w-4 h-4 animate-spin"}),h?"Loading...":"Load More"]})})]})]})})};export{c as default};
